# **Concinna Engine: The Master Plan (2024-2025)**

**æ ¸å¿ƒæˆ˜ç•¥ï¼š**
1.  **è¡¥å…¨æ„Ÿå®˜ (Sensory):** å…ˆé€ ä»ªè¡¨ç›˜ï¼ˆProfiler/Logï¼‰å’Œå®‰å…¨ç½‘ï¼ˆPanicï¼‰ï¼Œå†é€ æ–¹å‘ç›˜ï¼ˆUIï¼‰ã€‚
2.  **æ•°æ®é©±åŠ¨ (Data-Driven):** ä¸€åˆ‡çš†æ•°æ®ï¼ˆåå°„ã€åºåˆ—åŒ–ã€èµ„äº§ï¼‰ï¼Œä»£ç åªè´Ÿè´£å¤„ç†æ•°æ®ã€‚
3.  **å®Œå…¨æ§åˆ¶ (Total Control):** åšæŒ `no_std`ï¼ŒåšæŒå†…å­˜æ˜¾å¼ç®¡ç†ã€‚

---

## **Phase 0.5: è¡¥å…¨â€œé­”æ³•â€åŸºç¡€ (Foundation Magic)**
**å‘¨æœŸï¼š2å‘¨**
**ç›®æ ‡ï¼š** æ¶ˆé™¤â€œç›²å†™â€çŠ¶æ€ï¼Œè®©å¼•æ“å…·å¤‡è‡ªæˆ‘è¯Šæ–­å’Œè‡ªæˆ‘æè¿°èƒ½åŠ›ã€‚

### **1. å´©æºƒä¸æ—¥å¿— (Safety Net)**
*   **[Prm.Debug] Panic Handler:**
    *   å®ç° `#[panic_handler]`ã€‚
    *   **åŠŸèƒ½ï¼š** æ•è· Panic ä¿¡æ¯ -> æ•è·å †æ ˆ (Stack Trace) -> å†™å…¥ `crash.log` -> å¼¹å‡º Win32 MessageBox (é˜²æ­¢é™é»˜é€€å‡º)ã€‚
*   **[Cap.Log] ç»“æ„åŒ–æ—¥å¿—:**
    *   **é‡æ„ï¼š** ç§»é™¤ `println!`ï¼Œå…¨é¢æ¥ç®¡ stdout/stderrã€‚
    *   **åŠŸèƒ½ï¼š** æ”¯æŒ `Log::info!(Category, "msg")`ã€‚å®ç°ä¸€ä¸ªæ— é”çš„ RingBuffer Loggerï¼Œç”±ç‹¬ç«‹çº¿ç¨‹å†™å…¥æ–‡ä»¶ï¼Œé¿å…é˜»å¡ä¸»å¾ªç¯ã€‚

### **2. åå°„ç³»ç»Ÿ (The Mirror)**
*   **[Cap.Reflection] é™æ€åå°„ (Static Reflection):**
    *   **å®ç°ï¼š** ç¼–å†™ `derive(Reflect)` è¿‡ç¨‹å®ã€‚
    *   **åŠŸèƒ½ï¼š** ä¸º Component ç”Ÿæˆå…ƒæ•°æ®ï¼ˆå­—æ®µåã€ç±»å‹ã€åç§»é‡ï¼‰ã€‚
    *   **APIï¼š** `entity.get_field("x") -> Value` / `entity.set_field("x", 10.0)`ã€‚
    *   **å®šä½ï¼š** è¿™æ˜¯ UI (Inspector) å’Œ åºåˆ—åŒ– (Serializer) çš„åŸºçŸ³ã€‚

### **3. æ€§èƒ½é¥æµ‹ (Telemetry)**
*   **[Sys.Profiling] åŸºç¡€åŸ‹ç‚¹:**
    *   **å®ç°ï¼š** å®šä¹‰ `PROFILE_SCOPE!("Name")` å®ã€‚
    *   **åç«¯ï¼š**
        *   *Debug:* ç®€å•çš„ `rdtsc` è®¡æ—¶ï¼Œæ¯å¸§ç»“æŸæ‰“å° `Sim/Render` è€—æ—¶ã€‚
        *   *Release:* ç©ºå®ç°ï¼ˆé›¶å¼€é”€ï¼‰ã€‚
    *   **é¢„ç•™ï¼š** ä¸ºæœªæ¥æ¥å…¥ Tracy æˆ– Superluminal ç•™å¥½æ¥å£ï¼Œä½†æš‚ä¸é›†æˆé‡å‹åº“ã€‚

### **4. å†…å­˜ç›‘æ§ (Memory Tracking)**
*   **[Sys.Memory] å…¨å±€è´¦æœ¬:**
    *   **å®ç°ï¼š** åœ¨ `SystemMemoryResource` å’Œæ‰€æœ‰ `Allocator` ä¸­æ³¨å…¥è®¡æ•°å™¨ã€‚
    *   **åŠŸèƒ½ï¼š** å®æ—¶ç»Ÿè®¡ `TotalAllocated`, `FramePeak`, `AssetHeapUsage`ã€‚

---

## **Phase 1: èµ‹äºˆè§†è§‰ (Visualization & Editor)**
**å‘¨æœŸï¼š1ä¸ªæœˆ**
**ç›®æ ‡ï¼š** èƒ½å¤Ÿé€šè¿‡ UI å®æ—¶ä¿®æ”¹æ¸¸æˆçŠ¶æ€ï¼Œè€Œä¸æ˜¯æ”¹ä»£ç é‡å¯ã€‚

### **1. UI æ¡†æ¶æ¥å…¥ (The Eyes)**
*   **[Sys.UI] åç«¯å®ç°:**
    *   **é€‰å‹ï¼š** **egui** (å³æ—¶æ¨¡å¼ï¼ŒRust åŸç”Ÿï¼Œæ—  std ä¾èµ–è¾ƒå¥½å¤„ç†)ã€‚
    *   **é›†æˆï¼š** ç¼–å†™ `egui_concinna_backend`ã€‚
        *   *Input:* å°† `Prm.HID` äº‹ä»¶è½¬æ¢ä¸º `egui::RawInput`ã€‚
        *   *Render:* å°† `egui::Mesh` è½¬æ¢ä¸º `Sys.RHI` çš„é¡¶ç‚¹ç¼“å†²å’Œ DrawCallã€‚

### **2. å®æ—¶æ£€è§†å™¨ (The Inspector)**
*   **[Edt.Inspector] æ•°æ®ç»‘å®š:**
    *   **è”åŠ¨ï¼š** ç»“åˆ `Cap.Reflection` å’Œ `Sys.UI`ã€‚
    *   **é€»è¾‘ï¼š**
        1.  éå† `SimWorld` ä¸­çš„ Entityã€‚
        2.  åˆ©ç”¨åå°„è·å– Component åˆ—è¡¨ã€‚
        3.  åˆ©ç”¨åå°„è·å–å­—æ®µç±»å‹ï¼ˆ`f32` -> Slider, `bool` -> Checkboxï¼‰ã€‚
        4.  **åŒå‘ç»‘å®šï¼š** UI ä¿®æ”¹ -> åå°„ Set -> Sim æ•°æ®å˜æ›´ã€‚

### **3. è°ƒè¯•ç»˜å›¾ (Debug Draw)**
*   **[Sys.DebugRender] çº¿æ¡†æ¸²æŸ“:**
    *   **å®ç°ï¼š** ä¸€ä¸ªæç®€çš„ `Immediate Mode Renderer`ã€‚
    *   **APIï¼š** `draw_line(start, end, color)`, `draw_box(aabb, color)`ã€‚
    *   **ç”¨é€”ï¼š** å¯è§†åŒ–ç‰©ç†ç¢°æ’ä½“ã€AI è·¯å¾„ã€å…‰æºèŒƒå›´ã€‚

---

## **Phase 2: å·¥ä¸šåŒ–ç®¡çº¿ (The Pipeline)**
**å‘¨æœŸï¼š2-3ä¸ªæœˆ**
**ç›®æ ‡ï¼š** å»ºç«‹äºŒè¿›åˆ¶èµ„äº§æµï¼Œå®ç°çƒ­é‡è½½ï¼Œè„±ç¦»â€œç©å…·â€é˜¶æ®µã€‚

### **1. èµ„äº§ç¼–è¯‘å™¨ (Dev.AssetCompiler)**
*   **[Dev] ç‹¬ç«‹å·¥å…·:**
    *   è¿™æ˜¯ä¸€ä¸ªå…è®¸ä½¿ç”¨ `std` çš„ CLI å·¥å…·ã€‚
    *   **Mesh:** `glTF/FBX` -> **Concinna Mesh (SoA Binary)**ã€‚
    *   **Shader:** `.glsl` -> `glslc/dxc` -> **SPIR-V/DXIL**ã€‚
    *   **Texture:** `.png/.tga` -> **DDS/KTX (Block Compressed)**ã€‚

### **2. é›¶æ‹·è´åŠ è½½ (Zero-Copy IO)**
*   **[Sys.Resource] å†…å­˜æ˜ å°„:**
    *   **é‡æ„ï¼š** åºŸå¼ƒç›®å‰çš„æ–‡æœ¬è§£æåŠ è½½å™¨ã€‚
    *   **å®ç°ï¼š** ä½¿ç”¨ `Prm.File::map` (mmap)ã€‚ç›´æ¥å°†äºŒè¿›åˆ¶èµ„äº§æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡ `transmute` è·å–èµ„æºå¼•ç”¨ã€‚
    *   **æ”¶ç›Šï¼š** åŠ è½½æ—¶é—´ä» 100ms çº§é™ä½åˆ° 0.1ms çº§ã€‚

### **3. çƒ­é‡è½½ (Hot Reloading)**
*   **[Sys.HotReload] å®æ—¶æ›´æ–°:**
    *   **ç›‘æ§ï¼š** `Sys.VFS` ç›‘å¬æ–‡ä»¶å˜æ›´ï¼ˆ`ReadDirectoryChangesW`ï¼‰ã€‚
    *   **å“åº”ï¼š**
        *   Shader å˜ -> é‡å»º Pipelineã€‚
        *   Script å˜ -> é‡è½½ Lua/WASM æ¨¡å—ã€‚
        *   Texture å˜ -> é‡æ–°ä¸Šä¼  GPU å†…å­˜ã€‚

---

## **Phase 3: æ ¸å¿ƒèƒ½åŠ›å¢å¼º (Core Power)**
**å‘¨æœŸï¼šé•¿æœŸ**
**ç›®æ ‡ï¼š** å¡«å……æ¸²æŸ“å’Œç‰©ç†çš„ç¡¬æ ¸èƒ½åŠ›ã€‚

### **1. æ¸²æŸ“å›¾ (Render Graph)**
*   **[Sys.RenderGraph] è‡ªåŠ¨è°ƒåº¦:**
    *   å®ç°èµ„æºä¾èµ–åˆ†æã€‚
    *   è‡ªåŠ¨æ’å…¥ `PipelineBarrier` å’Œ `ImageLayoutTransition`ã€‚
    *   æ”¯æŒå¤š Passï¼ˆShadowMap -> GBuffer -> Lighting -> UIï¼‰ã€‚

### **2. ç¡®å®šæ€§ç‰©ç† (Deterministic Physics)**
*   **[Eng.Physics] ç‰©ç†é›†æˆ:**
    *   é›†æˆ **Rapier** æˆ– **Jolt** (éœ€ä¿®æ”¹ä¸ºç¡®å®šæ€§æ¨¡å¼)ã€‚
    *   å°†ç‰©ç†çŠ¶æ€çº³å…¥ `Sim` çš„å¿«ç…§ç®¡ç†ã€‚

### **3. ä»»åŠ¡ç³»ç»Ÿå¢å¼º (Job System)**
*   **[Sys.Task] ä¾èµ–å›¾:**
    *   å®Œå–„ `TaskGraph`ï¼Œæ”¯æŒæ›´å¤æ‚çš„ä»»åŠ¡ä¾èµ–ï¼ˆå¦‚ï¼šç‰©ç†è®¡ç®— -> åŠ¨ç”»æ›´æ–° -> æ¸²æŸ“æå–ï¼‰ã€‚

---

## **æ€»ç»“ï¼šä½ çš„â€œé­”æ³•â€æ¸…å•çŠ¶æ€**

| é­”æ³•åŠŸèƒ½ | æ¨¡å— | çŠ¶æ€ | è®¡åˆ’æ‰§è¡Œæ—¶é—´ |
| :--- | :--- | :--- | :--- |
| **Panic Handler** | `Prm.Debug` | âŒ ç¼ºå¤± | **Phase 0.5 (ç«‹å³)** |
| **Reflection** | `Cap.Reflection` | âŒ ç¼ºå¤± | **Phase 0.5 (ç«‹å³)** |
| **Profiling (Basic)** | `Sys.Profiling` | âŒ ç¼ºå¤± | **Phase 0.5 (ç«‹å³)** |
| **Memory Tracking** | `Sys.Memory` | âŒ ç¼ºå¤± | **Phase 0.5 (ç«‹å³)** |
| **UI Framework** | `Sys.UI` | âŒ ç¼ºå¤± | **Phase 1** |
| **Inspector** | `Edt.Inspector` | âŒ ç¼ºå¤± | **Phase 1** |
| **Debug Draw** | `Sys.DebugRender` | âŒ ç¼ºå¤± | **Phase 1** |
| **Binary Assets** | `Dev.Compiler` | âŒ ç¼ºå¤± | **Phase 2** |
| **Hot Reload** | `Sys.HotReload` | âŒ ç¼ºå¤± | **Phase 2** |
| **Render Graph** | `Sys.RenderGraph` | ğŸš§ ä»…éª¨æ¶ | **Phase 3** |

**ç»“è®ºï¼š** ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ã€‚ç°åœ¨ä¸è¦æ€¥ç€åš UIï¼Œå…ˆèŠ±ä¸¤å‘¨æ—¶é—´æŠŠ **Phase 0.5** çš„å››ä¸ªåŸºç¡€åŠŸèƒ½ï¼ˆPanic, Reflection, Profiling, Memoryï¼‰åšå‡ºæ¥ã€‚è¿™äº›æ˜¯æ‰€æœ‰ä¸Šå±‚å»ºç­‘çš„â€œé’¢ç­‹â€ã€‚