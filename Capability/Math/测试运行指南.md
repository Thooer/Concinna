# Math 模块测试运行指南

## 构建测试

### Debug 版本
```powershell
cmake --build Build --target PacketMathTest ExtendedMathTest --config Debug -j8
```

### Release 版本
```powershell
cmake --build Build --target PacketMathTest ExtendedMathTest --config Release -j8
```

## 运行测试

### 查找测试可执行文件
```powershell
Get-ChildItem Build -Recurse -Filter "PacketMathTest.exe" | % { $_.FullName }
Get-ChildItem Build -Recurse -Filter "ExtendedMathTest.exe" | % { $_.FullName }
```

### 运行基础测试套件 (PacketMathTest)
```powershell
# Debug 版本
& "Build\Foundation\Math\Debug\PacketMathTest.exe"

# Release 版本
& "Build\Foundation\Math\Release\PacketMathTest.exe"
```

**测试覆盖 (11个测试用例)**:
- `Math.Packet.Vector3_Dot_Cross_And_Length` - 基础向量运算
- `Math.Packet.Vector3_Normalize_Zero_Safe` - 零向量归一化
- `Math.Packet.Quaternion_Rotate_Z90` - 四元数旋转
- `Math.Packet.Matrix_Compose_TRS_Z90` - 矩阵组合
- `Math.Packet.Rsqrt_Accuracy_Check` - 快速平方根倒数精度
- `Math.Storage.HalfConversion_RoundTrip` - 半精度转换
- `Math.Storage.ToFloat_And_SoAAlignment` - SoA 对齐验证
- `Math.Compute.MaskedLoadStore_TailHandling` - 掩码尾部处理
- `Math.Compute.Vector3Packet_Lerp_Min_Max_Clamp` - 高阶算子
- `Math.Compute.QuaternionPacket_Conjugate_Multiply_Slerp` - 旋转组合
- `Math.LWC.BatchConvertPacket4` - LWC 批量转换

### 运行扩展测试套件 (ExtendedMathTest)
```powershell
# Debug 版本
& "Build\Foundation\Math\Debug\ExtendedMathTest.exe"

# Release 版本
& "Build\Foundation\Math\Release\ExtendedMathTest.exe"
```

**测试覆盖 (11个测试用例)**:
- `Math.Extreme.Vector3_ExtremeValues_MinMax` - 极值边界
- `Math.Extreme.Vector3_NearZero_Normalize` - 近零归一化
- `Math.Extreme.Quaternion_Identity_Invariance` - 单位四元数不变性
- `Math.Extreme.Quaternion_Slerp_SameQuaternions` - 同向插值退化
- `Math.Extreme.Matrix_Compose_UnitScale_Identity` - 单位矩阵组合
- `Math.Stability.LWC_Precision_LargeWorldCoordinates` - 大世界精度
- `Math.Stability.Half_Precision_Boundary_Values` - 半精度边界
- `Math.Batch.Vector3Packet_BatchProjection` - 批量投影
- `Math.Batch.Vector3Packet_BatchReject` - 批量排斥
- `Math.Batch.Vector3Packet_BatchReflect` - 批量反射
- `Math.Batch.Vector3Packet_BatchClampLength` - 批量长度约束
- `Math.Benchmark.ScalarVsPacket_Vector3Add` - 标量vs SIMD 基准
- `Math.Benchmark.BatchNormalize_Stability` - 批量归一化稳定性

## 测试配置

### 默认配置
```cpp
RunConfig config{};
config.workerCount = 4;          // 4线程并发测试
config.frameArenaSize = 128KB;   // 帧内存池
config.logLevel = LogLevel::Info; // 信息级日志
```

### 修改配置
编辑 `Samples/PacketMathTest.cppm` 或 `ExtendedMathTest.cppm` 的 `main()` 函数:
```cpp
config.workerCount = 8;           // 增加并发
config.logLevel = LogLevel::Verbose; // 详细日志
```

## 预期输出

### 成功运行示例
```
[Info] Running 11 tests in 4 workers...
[Pass] Math.Packet.Vector3_Dot_Cross_And_Length (1.2ms)
[Pass] Math.Packet.Vector3_Normalize_Zero_Safe (0.5ms)
...
[Summary] 11/11 tests passed, 0 failed (total: 15.3ms)
Exit code: 0
```

### 失败示例
```
[Fail] Math.Compute.Vector3Packet_Lerp_Min_Max_Clamp
  Expected: 2.0, Actual: 2.0001, Epsilon: 1e-6
  at line 157
[Summary] 10/11 tests passed, 1 failed
Exit code: 1
```

## 常见问题

### Q1: 找不到可执行文件
**A**: 确保先构建目标:
```powershell
cmake --build Build --target PacketMathTest --config Debug
```

### Q2: AVX2 指令集不支持
**A**: 检查 CPU 支持或切换到 SSE 后端:
- 修改 CMakeLists.txt 关闭 AVX2
- 或在旧 CPU 上运行 W=4 路径

### Q3: 测试失败
**A**: 检查精度容忍度,浮点运算可能因 FMA 重排导致微小差异:
```cpp
That(result, ctx).ToBeApproximately(expected, 1e-5f); // 放宽容忍度
```

### Q4: Release 版本找不到
**A**: Release 构建需要显式指定:
```powershell
cmake --build Build --config Release
```

## 性能基准

### 典型运行时间 (Intel i7-9700K, AVX2)
- PacketMathTest (Debug): ~50ms
- PacketMathTest (Release): ~8ms
- ExtendedMathTest (Debug): ~45ms
- ExtendedMathTest (Release): ~7ms

### 瓶颈分析
- Debug: 无优化 + 断言检查
- Release: SIMD 内联 + FMA 融合

## 持续集成

### CI 脚本示例
```powershell
# 构建
cmake -B Build -G "Visual Studio 17 2022"
cmake --build Build --config Release --target PacketMathTest ExtendedMathTest

# 测试
$result1 = & "Build\Foundation\Math\Release\PacketMathTest.exe"
$result2 = & "Build\Foundation\Math\Release\ExtendedMathTest.exe"

if ($LASTEXITCODE -ne 0) {
    Write-Error "Tests failed!"
    exit 1
}
```

---

最后更新: 2025-11-24  
版本: v1.0
