API(Primitive.Threading ${CMAKE_CURRENT_SOURCE_DIR}/API LINK Lang;Element;Flow;Semantics;Paradigm;Text)
Impl(Primitive.Threading.Windows ${CMAKE_CURRENT_SOURCE_DIR}/Impl/Windows)
Impl(Primitive.Threading.Noop ${CMAKE_CURRENT_SOURCE_DIR}/Impl/Noop)
Build(Threading TYPE STATIC BACKEND Primitive.Threading.Windows)

# 可选 Fiber 后端（默认 OS）：如需汇编版可扩展此段
set(THREADING_FIBER_BACKEND "OS" CACHE STRING "Fiber backend (ASM|OS)")
if(WIN32)
  get_property(_tb_backend GLOBAL PROPERTY "MODULE_Primitive.Threading_SELECTED_BACKEND")
  if(_tb_backend STREQUAL "Windows")
    if(THREADING_FIBER_BACKEND STREQUAL "ASM")
      enable_language(ASM_MASM)
      target_sources(Threading PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/Impl/Windows/FiberContext.asm)
    else()
      target_sources(Threading PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/Impl/Windows/FiberContextOS.cppm)
      target_compile_definitions(Threading PRIVATE PLATFORM_FIBER_BACKEND_OS)
    endif()
  endif()
endif()
set_target_properties(Threading PROPERTIES LINKER_Prim CXX)
apply_common_options(Threading)
